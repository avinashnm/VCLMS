{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}{{ experiment.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Materials & Procedure Sidebar -->
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">{{ experiment.name }}</h5>
        </div>
        <div class="card-body p-3">
          <h6 class="text-muted mb-3"><i class="fas fa-flask mr-2"></i>Materials:</h6>
          <ul class="list-unstyled small">
            {% for material in experiment.materials %}
              <li class="mb-1"><i class="fas fa-circle text-success mr-2"></i>{{ material }}</li>
            {% endfor %}
          </ul>
          
          <hr class="my-3">
          
          <h6 class="text-muted mb-3"><i class="fas fa-list-ol mr-2"></i>Procedure:</h6>
          <ol class="small mb-0">
            {% for step in experiment.procedure %}
              <li class="mb-2">{{ step }}</li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>
    
    <!-- Simulation Area -->
    <div class="col-md-9">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-vial mr-2"></i>Virtual Lab Simulation</h5>
        </div>
        <div class="card-body p-3">
          <div id="simulation-canvas" style="position: relative; border: 2px solid #28a745; border-radius: 8px; overflow: hidden;"></div>
        </div>
        <div class="card-footer bg-light">
          <button class="btn btn-success mr-2" onclick="resetExperiment()">
            <i class="fas fa-redo mr-1"></i>Reset Experiment
          </button>
          <button class="btn btn-primary" onclick="generateReport()">
            <i class="fas fa-file-pdf mr-1"></i>Generate Report
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/lab_catalog.js' %}"></script>
<script src="{% static 'js/titration_lab.js' %}"></script>
<script>
let experimentData = {{ experiment|safe }};
let studentVolume = 0; // Global for buttons

function resetExperiment() {
  studentVolume = 0;
  beaker.volume = 0;
  burette.volume = 50;
  pipette.volume = 25;
  phColor = [255, 255, 255];
}

function generateReport() {
  let accuracy = Math.abs(studentVolume - {{ experiment.expected_volume }}).toFixed(1);
  let status = accuracy < 2 ? 'PASS' : 'NEEDS IMPROVEMENT';
  alert(`Report Generated!\n\nVolume Used: ${studentVolume.toFixed(1)}ml\nExpected: {{ experiment.expected_volume }}ml\nError: ${accuracy}ml\nStatus: ${status}`);
}
</script>
{% endblock %}
